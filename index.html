<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemezy: The Virtual Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        
        /* Clean, modern educational theme */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --muted: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes chemicalDrop {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(0) rotate(360deg); opacity: 1; }
        }

        @keyframes bubbleUp {
            0% { bottom: 10%; opacity: 0; transform: translateX(0); }
            20% { opacity: 1; }
            100% { bottom: 90%; opacity: 0; transform: translateX(20px); }
        }

        .float-animation { animation: float 3s ease-in-out infinite; }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        .chemical-drop { animation: chemicalDrop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55); }

        /* Glass morphism */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Chemical element cards */
        .chemical-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            cursor: move;
        }

        .chemical-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .chemical-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        /* Reaction beaker animation */
        .beaker {
            position: relative;
            width: 200px;
            height: 250px;
            margin: 0 auto;
        }

        .beaker-liquid {
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            background: linear-gradient(to top, #3b82f6, #8b5cf6);
            border-radius: 0 0 20px 20px;
            transition: height 0.5s ease;
        }

        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 8px;
            height: 8px;
            animation: bubbleUp 3s infinite;
        }

        /* Notification styles */
        .notification-enter {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Discovery effect */
        .world-first-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            color: #fbbf24;
            text-shadow: 0 0 50px rgba(251, 191, 36, 0.8);
            animation: worldFirstPulse 2s ease-out;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes worldFirstPulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* Periodic table mini-view */
        .element-symbol {
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .element-symbol .number {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .element-symbol .symbol {
            font-size: 1.5rem;
        }
    </style>
</head>
<body x-data="chemezyApp()" x-init="init()">
    <!-- Loading Screen -->
    <div x-show="loading" x-cloak 
         class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="beaker mb-8">
                <svg viewBox="0 0 200 250" class="w-full h-full">
                    <path d="M50 20 L50 180 Q50 220 90 220 L110 220 Q150 220 150 180 L150 20" 
                          stroke="#3b82f6" stroke-width="3" fill="none"/>
                    <rect x="40" y="10" width="120" height="20" rx="10" fill="#3b82f6"/>
                </svg>
                <div class="beaker-liquid" :style="`height: ${loadingProgress}%`">
                    <div class="bubble" style="left: 20%; animation-delay: 0s;"></div>
                    <div class="bubble" style="left: 50%; animation-delay: 1s;"></div>
                    <div class="bubble" style="left: 80%; animation-delay: 2s;"></div>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Preparing Your Virtual Lab...</h2>
            <p class="text-gray-400">Loading chemical compounds</p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div x-show="!isAuthenticated" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="glass rounded-2xl p-8 max-w-md w-full slide-up">
            <div class="text-center mb-8">
                <div class="element-symbol mx-auto mb-4 float-animation">
                    <span class="number">6</span>
                    <span class="symbol">C</span>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Welcome to Chemezy</h1>
                <p class="text-gray-400">Your Virtual Chemistry Laboratory</p>
            </div>
            
            <form @submit.prevent="handleLogin" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                    <input type="text" x-model="loginForm.username" 
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                           placeholder="Enter your username" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <input type="password" x-model="loginForm.password" 
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                           placeholder="Enter your password" required>
                </div>
                <button type="submit" 
                        class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105"
                        :disabled="loginForm.loading">
                    <span x-show="!loginForm.loading">Start Experimenting</span>
                    <span x-show="loginForm.loading">Logging in...</span>
                </button>
            </form>
            
            <p class="text-center text-gray-400 text-sm mt-6">
                New to chemistry? Use demo/demo to explore!
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div x-show="isAuthenticated" x-cloak class="min-h-screen">
        <!-- Header -->
        <header class="glass border-b border-white/10 sticky top-0 z-30">
            <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="element-symbol w-12 h-12">
                        <span class="symbol text-lg">Cz</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Chemezy Lab</h1>
                        <p class="text-sm text-gray-400">Experiment • Discover • Learn</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-6">
                    <button @click="showTutorial = true" 
                            class="text-gray-300 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                    </button>
                    <div class="text-right">
                        <p class="text-sm text-gray-400">Scientist</p>
                        <p class="font-semibold text-white" x-text="username"></p>
                    </div>
                    <button @click="logout" 
                            class="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Lab Workspace (2 columns) -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Quick Add Chemical -->
                    <div class="glass rounded-xl p-6 slide-up">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Quick Add Chemical
                        </h2>
                        <div class="flex space-x-2">
                            <input type="text" x-model="newChemical" 
                                   @keyup.enter="addChemical"
                                   placeholder="Enter molecular formula (e.g., H2O, NaCl, C6H12O6)"
                                   class="flex-1 px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                            <button @click="addChemical" 
                                    class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all">
                                Add to Lab
                            </button>
                        </div>
                    </div>

                    <!-- Virtual Lab Bench -->
                    <div class="glass rounded-xl p-6 slide-up" style="animation-delay: 0.1s;">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                            </svg>
                            Virtual Lab Bench
                        </h2>
                        
                        <!-- Reaction Setup -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-3">Drag chemicals here to start reaction</label>
                            <div @drop="handleDrop($event)" 
                                 @dragover.prevent
                                 @dragenter.prevent
                                 class="min-h-[200px] bg-slate-800/30 border-2 border-dashed border-slate-600 rounded-lg p-4 transition-all"
                                 :class="{'border-blue-500 bg-blue-500/10': isDragging}">
                                
                                <!-- Beaker Animation -->
                                <div class="beaker mx-auto" x-show="reactants.length > 0">
                                    <svg viewBox="0 0 200 250" class="w-full h-full">
                                        <path d="M50 20 L50 180 Q50 220 90 220 L110 220 Q150 220 150 180 L150 20" 
                                              stroke="#3b82f6" stroke-width="3" fill="none"/>
                                        <rect x="40" y="10" width="120" height="20" rx="10" fill="#3b82f6"/>
                                    </svg>
                                    <div class="beaker-liquid" :style="`height: ${reactants.length * 30}%`">
                                        <template x-for="i in reactants.length" :key="i">
                                            <div class="bubble" :style="`left: ${20 + i * 30}%; animation-delay: ${i * 0.5}s;`"></div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Reactants Display -->
                                <div class="mt-4 flex flex-wrap gap-2 justify-center" x-show="reactants.length > 0">
                                    <template x-for="(reactant, index) in reactants" :key="index">
                                        <div class="chemical-card px-4 py-2 rounded-lg flex items-center space-x-2 chemical-drop">
                                            <span class="font-semibold text-white" x-text="reactant.molecular_formula"></span>
                                            <button @click="removeReactant(index)" class="text-red-400 hover:text-red-300">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                                
                                <p x-show="reactants.length === 0" class="text-center text-gray-500 mt-8">
                                    Drop chemicals here to begin experimenting
                                </p>
                            </div>
                        </div>
                        
                        <!-- Catalyst Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Catalyst (Optional)</label>
                            <select x-model="selectedCatalyst" 
                                    class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:border-blue-500 focus:outline-none">
                                <option value="">No catalyst</option>
                                <template x-for="chemical in chemicals" :key="chemical.id">
                                    <option :value="chemical.id" x-text="`${chemical.molecular_formula} ${chemical.common_name ? '(' + chemical.common_name + ')' : ''}`"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Run Reaction Button -->
                        <button @click="runReaction" 
                                :disabled="reactants.length === 0 || isReacting"
                                class="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold rounded-lg transition-all transform disabled:opacity-50 disabled:cursor-not-allowed"
                                :class="{'hover:scale-105 pulse-glow': reactants.length > 0 && !isReacting}">
                            <span x-show="!isReacting">Start Reaction</span>
                            <span x-show="isReacting" class="flex items-center justify-center">
                                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Reacting...
                            </span>
                        </button>
                    </div>

                    <!-- Results Panel -->
                    <div x-show="lastReaction" x-cloak class="glass rounded-xl p-6 slide-up">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Reaction Results
                        </h2>
                        
                        <div x-show="lastReaction.is_world_first" class="mb-4 p-4 bg-yellow-500/20 border border-yellow-500/50 rounded-lg">
                            <p class="text-yellow-400 font-bold text-lg">🏆 World-First Discovery!</p>
                            <p class="text-yellow-300 text-sm">You're the first to create this reaction!</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-semibold text-gray-300 mb-2">Explanation</h3>
                                <p class="text-white bg-slate-800/50 p-4 rounded-lg" x-text="lastReaction.explanation"></p>
                            </div>
                            
                            <div>
                                <h3 class="font-semibold text-gray-300 mb-2">Products</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    <template x-for="product in lastReaction.products" :key="product.chemical_id">
                                        <div class="chemical-card p-3 rounded-lg text-center">
                                            <p class="font-bold text-white" x-text="product.molecular_formula"></p>
                                            <p class="text-sm text-gray-400">Qty: <span x-text="product.quantity.toFixed(2)"></span></p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <div x-show="lastReaction.effects && lastReaction.effects.length > 0">
                                <h3 class="font-semibold text-gray-300 mb-2">Visual Effects</h3>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="effect in lastReaction.effects" :key="effect.effect_type">
                                        <span class="px-3 py-1 rounded-full text-sm"
                                              :style="`background-color: ${effect.color}20; color: ${effect.color}; border: 1px solid ${effect.color}50;`">
                                            <span x-text="effect.effect_type"></span> • 
                                            <span x-text="`Intensity: ${effect.intensity}`"></span>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="space-y-6">
                    <!-- Chemical Inventory -->
                    <div class="glass rounded-xl p-6 slide-up" style="animation-delay: 0.2s;">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                            </svg>
                            Chemical Inventory
                        </h2>
                        <div class="mb-4">
                            <input type="text" x-model="chemicalSearch" 
                                   placeholder="Search chemicals..."
                                   class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white text-sm placeholder-gray-400 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="chemical in filteredChemicals" :key="chemical.id">
                                <div draggable="true" 
                                     @dragstart="startDrag($event, chemical)"
                                     @dragend="endDrag"
                                     class="chemical-card p-3 rounded-lg cursor-move">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-white" x-text="chemical.molecular_formula"></p>
                                            <p class="text-sm text-gray-400" x-text="chemical.common_name || 'Unknown compound'"></p>
                                        </div>
                                        <div class="element-symbol w-10 h-10" x-show="chemical.molecular_formula.length <= 3">
                                            <span class="symbol text-sm" x-text="chemical.molecular_formula"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Achievements -->
                    <div class="glass rounded-xl p-6 slide-up" style="animation-delay: 0.3s;">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                            </svg>
                            Achievements
                        </h2>
                        <div class="space-y-3 max-h-80 overflow-y-auto">
                            <template x-for="award in myAwards" :key="award.id">
                                <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                    <div class="flex items-center justify-between mb-1">
                                        <p class="font-semibold text-yellow-400" x-text="award.template.name"></p>
                                        <span class="text-xs text-gray-400">Tier <span x-text="award.tier"></span></span>
                                    </div>
                                    <p class="text-sm text-gray-300" x-text="award.template.description"></p>
                                </div>
                            </template>
                            <p x-show="myAwards.length === 0" class="text-center text-gray-500 py-4">
                                Start experimenting to earn achievements!
                            </p>
                        </div>
                    </div>

                    <!-- Leaderboard -->
                    <div class="glass rounded-xl p-6 slide-up" style="animation-delay: 0.4s;">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Leaderboard
                        </h2>
                        <div class="mb-3">
                            <select x-model="selectedLeaderboardCategory" 
                                    @change="fetchLeaderboard"
                                    class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white text-sm focus:border-blue-500 focus:outline-none">
                                <option value="discovery">Discoveries</option>
                                <option value="database_contribution">Contributions</option>
                                <option value="achievement">Achievements</option>
                                <option value="community">Community</option>
                                <option value="special">Special</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <template x-for="(entry, index) in leaderboard" :key="entry.user_id">
                                <div class="flex items-center justify-between p-2 rounded bg-slate-800/30"
                                     :class="{'bg-gradient-to-r from-yellow-500/20 to-orange-500/20': index === 0}">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-bold text-gray-400" x-text="`#${entry.rank}`"></span>
                                        <span class="text-white" x-text="entry.username"></span>
                                    </div>
                                    <span class="font-semibold text-blue-400" x-text="`${entry.total_points} pts`"></span>
                                </div>
                            </template>
                            <p x-show="leaderboard.length === 0" class="text-center text-gray-500 py-4">
                                No data available
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div x-show="showTutorial" @click.away="showTutorial = false" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="glass rounded-2xl p-8 max-w-2xl w-full max-h-[80vh] overflow-y-auto slide-up">
            <h2 class="text-2xl font-bold text-white mb-6">How to Use Chemezy Lab</h2>
            
            <div class="space-y-6 text-gray-300">
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">1. Add Chemicals</h3>
                    <p>Start by adding chemicals to your inventory using the Quick Add feature. Enter molecular formulas like H2O, NaCl, or C6H12O6.</p>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">2. Drag & Drop</h3>
                    <p>Drag chemicals from your inventory to the Virtual Lab Bench. You can combine multiple chemicals to see what happens!</p>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">3. Run Reactions</h3>
                    <p>Click "Start Reaction" to see what happens. The system will show you the products, effects, and educational explanations.</p>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-white mb-2">4. Discover & Learn</h3>
                    <p>Make world-first discoveries and earn achievements! Each reaction comes with detailed explanations to help you understand the chemistry.</p>
                </div>
                
                <div class="bg-blue-500/20 p-4 rounded-lg border border-blue-500/30">
                    <p class="text-sm"><strong>Pro tip:</strong> Try adding a catalyst to speed up reactions or change their outcomes!</p>
                </div>
            </div>
            
            <button @click="showTutorial = false" 
                    class="mt-6 w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all">
                Start Experimenting!
            </button>
        </div>
    </div>

    <!-- Notifications -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
        <template x-for="(notification, index) in notifications" :key="notification.id">
            <div class="notification-enter glass rounded-lg px-6 py-4 min-w-[300px] cursor-pointer"
                 @click="removeNotification(index)"
                 :class="{
                     'border-green-500/50': notification.type === 'success',
                     'border-red-500/50': notification.type === 'error',
                     'border-blue-500/50': notification.type === 'info',
                     'border-yellow-500/50': notification.type === 'warning'
                 }">
                <p class="font-semibold" 
                   :class="{
                       'text-green-400': notification.type === 'success',
                       'text-red-400': notification.type === 'error',
                       'text-blue-400': notification.type === 'info',
                       'text-yellow-400': notification.type === 'warning'
                   }"
                   x-text="notification.title"></p>
                <p class="text-sm text-gray-300" x-text="notification.message"></p>
            </div>
        </template>
    </div>

    <!-- World First Discovery Effect -->
    <div x-show="showWorldFirstEffect" x-cloak class="world-first-effect">
        🏆 WORLD FIRST! 🏆
    </div>

    <script>
        function chemezyApp() {
            return {
                // State
                loading: true,
                loadingProgress: 0,
                isAuthenticated: false,
                username: '',
                authToken: null,
                showTutorial: false,
                showWorldFirstEffect: false,
                
                // UI State
                notifications: [],
                isDragging: false,
                isReacting: false,
                
                // Form Data
                loginForm: {
                    username: '',
                    password: '',
                    loading: false
                },
                newChemical: '',
                chemicalSearch: '',
                
                // Game Data
                chemicals: [],
                reactants: [],
                selectedCatalyst: '',
                lastReaction: null,
                myAwards: [],
                leaderboard: [],
                selectedLeaderboardCategory: 'discovery',
                
                // API Base URL
                API_BASE: '/api/v1',
                
                // Computed
                get filteredChemicals() {
                    if (!this.chemicalSearch) return this.chemicals;
                    const search = this.chemicalSearch.toLowerCase();
                    return this.chemicals.filter(c => 
                        c.molecular_formula.toLowerCase().includes(search) ||
                        (c.common_name && c.common_name.toLowerCase().includes(search))
                    );
                },
                
                // Methods
                async init() {
                    // Simulate loading
                    for (let i = 0; i <= 100; i += 10) {
                        this.loadingProgress = i;
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    // Check stored auth
                    const storedToken = localStorage.getItem('chemezy_token');
                    const storedUsername = localStorage.getItem('chemezy_username');
                    
                    if (storedToken && storedUsername) {
                        this.authToken = storedToken;
                        this.username = storedUsername;
                        this.isAuthenticated = true;
                        await this.loadInitialData();
                    }
                    
                    this.loading = false;
                },
                
                async apiRequest(endpoint, options = {}) {
                    const headers = {
                        'Content-Type': 'application/json',
                        ...options.headers
                    };
                    
                    if (this.authToken) {
                        headers['Authorization'] = `Bearer ${this.authToken}`;
                    }
                    
                    try {
                        const response = await fetch(`${this.API_BASE}${endpoint}`, {
                            ...options,
                            headers
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'API request failed');
                        }
                        
                        return response.status === 204 ? null : await response.json();
                    } catch (error) {
                        throw error;
                    }
                },
                
                async handleLogin() {
                    this.loginForm.loading = true;
                    
                    try {
                        const formData = new URLSearchParams();
                        formData.append('username', this.loginForm.username);
                        formData.append('password', this.loginForm.password);
                        
                        const response = await this.apiRequest('/auth/token', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: formData
                        });
                        
                        this.authToken = response.access_token;
                        this.username = this.loginForm.username;
                        this.isAuthenticated = true;
                        
                        // Store auth
                        localStorage.setItem('chemezy_token', this.authToken);
                        localStorage.setItem('chemezy_username', this.username);
                        
                        // Load initial data
                        await this.loadInitialData();
                        
                        this.showNotification('Welcome to Chemezy Lab!', 'success', `Logged in as ${this.username}`);
                    } catch (error) {
                        this.showNotification('Login Failed', 'error', error.message);
                    } finally {
                        this.loginForm.loading = false;
                    }
                },
                
                logout() {
                    this.isAuthenticated = false;
                    this.authToken = null;
                    this.username = '';
                    localStorage.removeItem('chemezy_token');
                    localStorage.removeItem('chemezy_username');
                    this.loginForm.username = '';
                    this.loginForm.password = '';
                    this.showNotification('Logged Out', 'info', 'See you next time!');
                },
                
                async loadInitialData() {
                    try {
                        const [chemicalsData, awardsData] = await Promise.all([
                            this.apiRequest('/chemicals/'),
                            this.apiRequest('/awards/me')
                        ]);
                        
                        this.chemicals = chemicalsData.results || [];
                        this.myAwards = awardsData || [];
                        
                        await this.fetchLeaderboard();
                    } catch (error) {
                        this.showNotification('Error', 'error', 'Failed to load initial data');
                    }
                },
                
                async addChemical() {
                    if (!this.newChemical.trim()) return;
                    
                    try {
                        const chemical = await this.apiRequest('/chemicals/', {
                            method: 'POST',
                            body: JSON.stringify({
                                molecular_formula: this.newChemical.trim()
                            })
                        });
                        
                        this.chemicals.push(chemical);
                        this.showNotification('Chemical Added', 'success', `${chemical.molecular_formula} has been added to your inventory`);
                        this.newChemical = '';
                    } catch (error) {
                        this.showNotification('Error', 'error', error.message);
                    }
                },
                
                startDrag(event, chemical) {
                    event.dataTransfer.effectAllowed = 'copy';
                    event.dataTransfer.setData('chemical', JSON.stringify(chemical));
                    this.isDragging = true;
                    event.target.classList.add('dragging');
                },
                
                endDrag(event) {
                    this.isDragging = false;
                    event.target.classList.remove('dragging');
                },
                
                handleDrop(event) {
                    event.preventDefault();
                    this.isDragging = false;
                    
                    try {
                        const chemical = JSON.parse(event.dataTransfer.getData('chemical'));
                        
                        // Check if already added
                        if (!this.reactants.find(r => r.id === chemical.id)) {
                            this.reactants.push(chemical);
                            this.showNotification('Chemical Added', 'info', `${chemical.molecular_formula} added to reaction`);
                        } else {
                            this.showNotification('Already Added', 'warning', 'This chemical is already in the reaction');
                        }
                    } catch (error) {
                        console.error('Drop error:', error);
                    }
                },
                
                removeReactant(index) {
                    this.reactants.splice(index, 1);
                },
                
                async runReaction() {
                    if (this.reactants.length === 0) return;
                    
                    this.isReacting = true;
                    
                    try {
                        const reactionData = {
                            reactants: this.reactants.map(r => ({
                                chemical_id: r.id,
                                quantity: 1.0
                            })),
                            catalyst_id: this.selectedCatalyst || null,
                            environment: "Earth (Normal)"
                        };
                        
                        const result = await this.apiRequest('/reactions/react', {
                            method: 'POST',
                            body: JSON.stringify(reactionData)
                        });
                        
                        this.lastReaction = result;
                        
                        if (result.is_world_first) {
                            this.showWorldFirstDiscovery();
                            // Reload awards
                            const awardsData = await this.apiRequest('/awards/me');
                            this.myAwards = awardsData || [];
                        }
                        
                        this.showNotification('Reaction Complete', 'success', 'Check the results below!');
                        
                        // Clear reactants
                        this.reactants = [];
                        this.selectedCatalyst = '';
                    } catch (error) {
                        this.showNotification('Reaction Failed', 'error', error.message);
                    } finally {
                        this.isReacting = false;
                    }
                },
                
                async fetchLeaderboard() {
                    try {
                        const data = await this.apiRequest(`/awards/leaderboard/${this.selectedLeaderboardCategory}`);
                        this.leaderboard = data || [];
                    } catch (error) {
                        console.error('Failed to fetch leaderboard:', error);
                    }
                },
                
                showWorldFirstDiscovery() {
                    this.showWorldFirstEffect = true;
                    setTimeout(() => {
                        this.showWorldFirstEffect = false;
                    }, 2000);
                    
                    this.showNotification('World First!', 'warning', 'Congratulations! You\'ve made a new discovery!');
                },
                
                showNotification(title, type, message) {
                    const notification = {
                        id: Date.now(),
                        title,
                        type,
                        message
                    };
                    
                    this.notifications.push(notification);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        const index = this.notifications.findIndex(n => n.id === notification.id);
                        if (index > -1) {
                            this.notifications.splice(index, 1);
                        }
                    }, 5000);
                },
                
                removeNotification(index) {
                    this.notifications.splice(index, 1);
                }
            };
        }
    </script>
</body>
</html>